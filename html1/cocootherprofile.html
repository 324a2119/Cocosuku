<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ユーザープロフィール — ココスク</title>
<style>
:root {
  --bg:#fff7f9;
  --card:#fff;
  --accent:#ffd1dc;
  --accent2:#ffeeba;
  --text:#444;
  --muted:#888;
  --radius:16px;
  font-family:"Noto Sans JP","Rounded Mplus 1c",sans-serif;
}
*{box-sizing:border-box;}
body{margin:0;padding:0;background:var(--bg);color:var(--text);overflow-x:hidden;}
.app{display:flex;flex-direction:column;max-width:600px;margin:0 auto;min-height:100vh;padding-bottom:80px;padding:8px;}

/* ヘッダー */
.header-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:16px;
  padding:8px 8px; 
}
.brand{display:flex;align-items:center;gap:8px;cursor:pointer;}
.logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#fff;font-size:18px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.app-name{font-size:20px;font-weight:bold;}

/* プロフィール */
.profile-area{
  display:flex;
  flex-direction:column;
  align-items:center;
  background:var(--card);
  padding:20px;
  border-radius:var(--radius);
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:20px;
}
.profile-icon{
  width:80px;
  height:80px;
  background:linear-gradient(45deg,#a0d1ff,#c3e2ff);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#fff;
  font-size:36px;
  margin-bottom:12px;
}
.profile-name{font-size:24px;font-weight:bold;margin-bottom:4px;}
.profile-bio{color:var(--muted);font-size:15px;margin-bottom:16px;}
.stats-bar{display:flex;gap:20px;}
.stat-item{text-align:center;font-size:14px;}
.stat-count{font-weight:bold;color:var(--text);font-size:18px;cursor:pointer;}
.action-btn-group{display:flex;gap:10px;margin-top:16px;}
.follow-btn{
  padding:8px 20px;
  border:1px solid var(--accent);
  border-radius:12px;
  background:var(--accent);
  color:var(--text);
  font-weight:bold;
  cursor:pointer;
}
.follow-btn.following{background:#fff;color:var(--text);}
.dm-btn{
  padding:8px 20px;
  border:1px solid #ddd;
  border-radius:12px;
  background:#fff;
  color:var(--text);
  font-weight:bold;
  cursor:pointer;
}

/* 投稿カード */
.post-card{
  background:var(--card);
  padding:16px;
  border-radius:var(--radius);
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  margin-bottom:16px;
}
.post-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.icon{
  width:40px;height:40px;background:#ffeeba;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;color:var(--text);font-size:16px;
}
.user-name{font-weight:bold;}
.time{font-size:12px;color:var(--muted);}
.post-content{margin-bottom:12px;line-height:1.5;}
.post-image{max-width:100%;border-radius:10px;margin-bottom:12px;}
.post-footer{display:flex;align-items:center;gap:8px;}
.like-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:4px;}
.like-btn.liked{color:red;}

/* モーダル */
.modal{
  display:none;
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.3);
  justify-content:center;
  align-items:center;
  z-index:100;
}
.modal-content{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  width:300px;
  max-height:70vh;
  overflow-y:auto;
}
.modal-close{text-align:right;font-size:18px;cursor:pointer;color:var(--muted);}
.modal-user{
  display:flex;
  align-items:center;
  padding:8px;
  border-bottom:1px solid #eee;
  gap:8px;
}
.modal-avatar{
  width:40px;height:40px;
  border-radius:50%;
  background:var(--accent2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  cursor:pointer;
}

/* ナビバー */
.nav-bar{
  position:fixed;bottom:0;left:0;right:0;height:60px;
  max-width:600px;margin:0 auto;
  background:var(--card);
  box-shadow:0 -2px 6px rgba(0,0,0,0.1);
  display:flex;justify-content:space-around;align-items:center;
  border-radius:var(--radius) var(--radius) 0 0;z-index:15;
}
.nav-item{flex:1;text-align:center;text-decoration:none;color:var(--muted);font-size:11px;cursor:pointer;padding:8px 0;}
.nav-item.active{color:#ff7fa3;font-weight:bold;}
.nav-item:hover{background:rgba(0,0,0,0.05);border-radius:10px;}
</style>
</head>
<body>
<div class="app">

  <div class="header-bar">
    <div class="brand" onclick="goTimeline()">
      <div class="logo">コ</div>
      <div class="app-name" id="userNameHeader">...</div>
    </div>
  </div>

  <div class="profile-area">
    <div class="profile-icon" id="profileIcon">?</div>
    <div class="profile-name" id="profileName">Loading...</div>
    <div class="profile-bio" id="profileBio"></div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-count" id="followingCount" onclick="openFollowModal('following')">0</div>
        <div>フォロー</div>
      </div>
      <div class="stat-item">
        <div class="stat-count" id="followerCount" onclick="openFollowModal('followers')">0</div>
        <div>フォロワー</div>
      </div>
      <div class="stat-item">
        <div class="stat-count" id="postCount">0</div>
        <div>投稿</div>
      </div>
    </div>
    
    <div class="action-btn-group">
      <button class="follow-btn" id="followBtn" onclick="toggleFollow()">フォロー</button>
      <button class="dm-btn" onclick="startChat()">💬 DMを送る</button>
    </div>
  </div>

  <h3 style="margin-top:0;">投稿一覧</h3>
  <div id="userPostsDiv">
    <div style="text-align:center; color:var(--muted); margin-top:20px;">投稿を読み込み中...</div>
  </div>

  <!-- モーダル -->
  <div id="followModal" class="modal" onclick="closeFollowModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-close" onclick="closeFollowModal()">×</div>
      <h3 id="modalTitle">ユーザー一覧</h3>
      <div id="followList"></div>
    </div>
  </div>

  <div class="nav-bar">
    <a href="cocotimeline.html" class="nav-item">🏠 TL</a>
    <a href="cocosearch.html" class="nav-item">🔍 検索</a>
    <a href="coconotifications.html" class="nav-item">🔔 通知</a>
    <a href="cocochat.html" class="nav-item">💬 DM</a>
    <a href="cocoprofile.html" class="nav-item">👤 プロフ</a>
    <a href="cococalendar.html" class="nav-item">📅 予定</a>
  </div>
</div>

<script>
let posts = JSON.parse(localStorage.getItem("posts") || "[]");
let follows = JSON.parse(localStorage.getItem("follows") || "{}");
let myProfile = JSON.parse(localStorage.getItem("profile") || '{"name":"ゲスト","avatar":"ゲ"}');

if(!localStorage.getItem("isLoggedIn")) window.location.href="cocologin.html";

// URLからユーザー名を取得
const urlParams = new URLSearchParams(window.location.search);
const userName = urlParams.get("user");

// プロフィール情報
const mockProfiles = {
  "そら": { name:"そら", bio:"趣味は写真、サークルはテニスです。", avatar:"そ" },
  "たけっちょ": { name:"たけっちょ", bio:"勉強頑張ってます！", avatar:"た" },
  "みかん": { name:"みかん", bio:"文学部所属。読書が趣味。", avatar:"み" },
  [myProfile.name]: myProfile
};
const userProfile = mockProfiles[userName] || { name:userName, bio:"このユーザーの情報は登録されていません。", avatar:userName?userName[0]:"?" };

// 自分自身なら cocoprofile.html へ
if(userName === myProfile.name){
  window.location.href = "cocoprofile.html";
}

document.getElementById("profileIcon").textContent = userProfile.avatar;
document.getElementById("profileName").textContent = userProfile.name;
document.getElementById("profileBio").textContent = userProfile.bio;
document.getElementById("userNameHeader").textContent = userProfile.name;

function goTimeline(){ window.location.href="cocotimeline.html"; }

function updateFollowBtn(){
  const isFollowing = follows[myProfile.name] && follows[myProfile.name].includes(userProfile.name);
  const btn=document.getElementById("followBtn");
  if(isFollowing){
    btn.textContent="フォロー中";
    btn.classList.add("following");
  }else{
    btn.textContent="フォロー";
    btn.classList.remove("following");
  }
}

function toggleFollow(){
  if(!follows[myProfile.name]) follows[myProfile.name]=[];
  const idx = follows[myProfile.name].indexOf(userProfile.name);
  if(idx>=0) follows[myProfile.name].splice(idx,1);
  else follows[myProfile.name].push(userProfile.name);
  localStorage.setItem("follows",JSON.stringify(follows));
  updateFollowBtn();updateStats();
}

function startChat(){
  window.location.href=`cocochat.html?target=${encodeURIComponent(userProfile.name)}`;
}

function updateStats(){
  if(!follows[userProfile.name]) follows[userProfile.name]=[];
  document.getElementById("followingCount").textContent=follows[userProfile.name].length;
  let c=0;
  for(const k in follows){if(follows[k].includes(userProfile.name)) c++;}
  document.getElementById("followerCount").textContent=c;
  document.getElementById("postCount").textContent=posts.filter(p=>p.name===userProfile.name).length;
}

function renderUserPosts(){
  const div=document.getElementById("userPostsDiv");
  const userPosts=posts.filter(p=>p.name===userProfile.name);
  div.innerHTML="";
  if(userPosts.length===0){
    div.innerHTML="<div style='color:var(--muted);text-align:center;'>まだ投稿がありません。</div>";
    return;
  }
  userPosts.slice().reverse().forEach((p,i)=>{
    const card=document.createElement("div");
    card.className="post-card";
    const time=new Date(p.time).toLocaleString("ja-JP",{hour12:false});
    const liked=p.liked?"liked":"";
    const img=p.image?`<img src='${p.image}' class='post-image'>`:"";
    card.innerHTML=`
      <div class='post-header'>
        <div class='icon'>${p.avatar}</div>
        <div><div class='user-name'>${p.name}</div><div class='time'>${time}</div></div>
      </div>
      <div class='post-content'>${p.text.replace(/\n/g,"<br>")}</div>
      ${img}
      <div class='post-footer'>
        <button class='like-btn ${liked}' onclick='toggleLike(${i})'>❤️</button>
        <span>${p.likes||0}</span>
      </div>`;
    div.appendChild(card);
  });
}

function toggleLike(i){
  const userPosts=posts.filter(p=>p.name===userProfile.name);
  const target=userPosts[userPosts.length-1-i];
  const original=posts.findIndex(p=>p===target);
  if(original!==-1){
    posts[original].liked=!posts[original].liked;
    posts[original].likes=(posts[original].likes||0)+(posts[original].liked?1:-1);
    localStorage.setItem("posts",JSON.stringify(posts));
    renderUserPosts();
  }
}

// ===== モーダル処理 =====
function openFollowModal(type){
  const modal=document.getElementById("followModal");
  const list=document.getElementById("followList");
  const title=document.getElementById("modalTitle");
  list.innerHTML="";
  let users=[];
  if(type==="following"){
    title.textContent="フォロー中のユーザー";
    users=follows[userProfile.name]||[];
  }else{
    title.textContent="フォロワー";
    for(const k in follows){
      if(follows[k].includes(userProfile.name)) users.push(k);
    }
  }
  if(users.length===0){
    list.innerHTML="<p style='text-align:center;color:var(--muted);margin:8px 0;'>ユーザーはいません。</p>";
  }else{
    users.forEach(u=>{
      const div=document.createElement("div");
      div.className="modal-user";
      div.innerHTML=`
        <div class='modal-avatar' onclick="goOtherProfile('${u}')">${u[0]}</div>
        <div style='flex:1;cursor:pointer;' onclick="goOtherProfile('${u}')">${u}</div>`;
      list.appendChild(div);
    });
  }
  modal.style.display="flex";
}

function closeFollowModal(){
  document.getElementById("followModal").style.display="none";
}

function goOtherProfile(u){
  closeFollowModal();
  if(u!==userProfile.name){
    window.location.href=`cocootherprofile.html?user=${encodeURIComponent(u)}`;
  }
}

updateFollowBtn();
updateStats();
renderUserPosts();
</script>
</body>
</html>
